# Description: Thinstation essential package
# URL: http://www.thinstation.org
# Maintainer: Donald A. Cupp Jr. (don cupp jr at ya hoo dot com)

name=kernel-TS_SMP
pname=${name%-*}
version=3.4.70
sversion=3.4.70
kname=${version}TS_SMP
release=1
source=(ftp://ftp.kernel.org/pub/linux/kernel/v3.x/linux-$sversion.tar.bz2 \
        https://raw.github.com/mjanusz/homepage/master/projects/fbcondecor/fbcondecor-0.9.6-3.5-rc3.patch \
	vgastate.patch
	/usr/src/kernels/aufs/patches/aufs3.patch \
	ts.config)

build() {
#export MAKEFLAGS="-j5"
	cd linux-$sversion
	cp $SRC/ts.config ./.config

#	if [ -e ~/.ssh/id_rsa ]; then
#		ln -sf ~/.ssh/id_rsa signing_key.priv
#		openssl x509 -outform der -in signing_key.priv -out signing_key.x509
#	fi
	patch -p1 -i $SRC/fbcondecor-0.9.6-3.5-rc3.patch
	patch -p1 -i $SRC/aufs3.patch
	patch -p0 -i $SRC/vgastate.patch

	make modules_prepare __headers
	mkdir -p $PKG/usr/src/kernels/$kname
	cp --parents `find -type f -name "Makefile*" -o -name "Kconfig*"` $PKG/usr/src/kernels/$kname
	rm -rf $PKG/usr/src/kernels/$kname/Documentation
	cp -a {include,scripts,.config} $PKG/usr/src/kernels/$kname
	cp -a arch/x86/include $PKG/usr/src/kernels/$kname/arch/x86
	rm $PKG/usr/src/kernels/$kname/scripts/{mod,kconfig}/*.o

	make -j5
	make INSTALL_PATH=$PKG install
	make INSTALL_MOD_PATH=$PKG modules_install

	cp -a Module.symvers System.map $PKG/usr/src/kernels/$kname

	cd $PKG
        mkdir -p $PKG/boot
	mv vmlinuz $PKG/boot/vmlinuz-$kname
	mv System.map $PKG/boot/System.map-$kname
	cp $SRC/linux-$sversion/.config $PKG/boot/config-$kname
#	echo $kname >$PKG/boot/KERNEL_VERSION

        rm lib/modules/$kname/{source,build}
	ln -sf /usr/src/kernels/$kname $PKG/lib/modules/$kname/build
	ln -sf build $PKG/lib/modules/$kname/source
	ln -sf . $PKG/usr/src/kernels/$kname/build
	rm $PKG/lib/modules/$kname/modules.{alias,alias.bin,builtin.bin,dep,dep.bin,devname,softdep,symbols,symbols.bin}
	rm -rf $PKG/lib/firmware
}
