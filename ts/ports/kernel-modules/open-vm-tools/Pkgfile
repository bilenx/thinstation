# Description: Thinstation essential package
# URL: http://www.thinstation.org
# Maintainer: Donald A. Cupp Jr. (don cupp jr at ya hoo dot com)

name=open-vm-tools
version=2013.04.16-1098359
kver=3.4.70
release=1
source=(http://downloads.sourceforge.net/project/open-vm-tools/open-vm-tools/Development%20Snapshots/open-vm-tools-$version.tar.gz
	open-vm-tools-2013.04.16-1098359-vmhgfs-linux-310.patch)

build() {
	cd $name-$version

	patch -p0 < ../open-vm-tools-2013.04.16-1098359-vmhgfs-linux-310.patch

	export CUSTOM_PROCPS_NAME=procps
	export CUSTOM_PROCPS_LIBS=-L/usr/lib/libprocps.so
#	sed -i -e 's/s_frozen/s_writers.frozen/g' modules/linux/vmsync/sync.c

	CFLAGS="$CFLAGS -Wno-deprecated-declarations" ./configure --prefix=/usr \
			--sysconfdir=/etc \
			--mandir=/usr/man \
			--with-kernel-release=${kver}TS_SMP \
			--with-linuxdir=/usr/src/kernels/${kver}TS_SMP \
			--disable-docs \
			--with-gtkmm \
			--without-icu

	make
	make DESTDIR=$PKG install
	make clean

        CFLAGS="$CFLAGS -Wno-deprecated-declarations" ./configure --prefix=/usr \
			--sysconfdir=/etc \
			--mandir=/usr/man \
			--with-kernel-release=${kver}TS \
			--with-linuxdir=/usr/src/kernels/${kver}TS \
			--disable-docs \
			--with-gtkmm \
			--without-icu

	make
	make DESTDIR=$PKG install

	mkdir -p $PKG/lib/modules
	mv $PKG/usr/src/kernels/* $PKG/lib/modules/.
	rm -r $PKG/sbin
	rm -r $PKG/usr/src
	rm -r $PKG/usr/{share,include}
	find $PKG/usr -name *.la -delete
	find $PKG/usr -name *.a -delete
}
